<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Logs - Admin Dashboard</title>

    <!-- Prevent page caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Immediate session check -->
    <script>
        document.documentElement.style.visibility = 'hidden';
        (function() {
            console.log('[LOGS] Checking session...');
            fetch('/php/api/auth/session.php', {
                credentials: 'include',
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(res => {
                    console.log('[LOGS] Session response status:', res.status);
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('[LOGS] Session data:', data);
                    if (!data.success) {
                        console.log('[LOGS] Session check failed:', data.message);
                        window.location.replace('/admin/login.html');
                        return;
                    }
                    if (data.data.user.role !== 'admin') {
                        console.log('[LOGS] Not admin, redirecting...');
                        window.location.replace('/admin/login.html');
                        return;
                    }
                    console.log('[LOGS] ‚úÖ Session valid');
                    document.documentElement.style.visibility = 'visible';
                })
                .catch(error => {
                    console.error('[LOGS] Session check error:', error);
                    window.location.replace('/admin/login.html');
                });
        })();
    </script>

    <link rel="stylesheet" href="/admin/assets/css/admin-professional.css">
    <script src="/admin/assets/js/badge-loader.js" defer></script>
    <script src="/admin/assets/js/pending-badge.js" defer></script>

    <style>
        /* Table cell truncation */
        .data-table td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table td:hover {
            overflow: visible;
            white-space: normal;
            word-break: break-word;
        }
    </style>
</head>
<body>
<div class="admin-layout">
    <!-- Sidebar Navigation -->
    <aside class="admin-sidebar">
        <div class="admin-brand">
            <h1>Accounting System</h1>
            <p class="admin-role">Administrator</p>
        </div>

            <!-- Logout Button - Easy Access -->
            <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <button class="btn-logout" id="logoutBtn" style="width: 100%; padding: 1rem">
                    Logout
                </button>
            </div>

            <nav class="admin-nav">
                <a href="/admin/dashboard.html" class="admin-nav-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/companies.html" class="admin-nav-item">
                    <span class="icon">üè¢</span>
                    <span>Companies</span>
                </a>
                <a href="/admin/accounts.html" class="admin-nav-item">
                    <span class="icon">üí∞</span>
                    <span>Account Management</span>
                </a>
                <a href="/admin/transactions.html" class="admin-nav-item">
                    <span class="icon">üí∏</span>
                    <span>All Transactions</span>
                </a>
                <a href="/admin/tenants.html" class="admin-nav-item">
                    <span class="icon">üë•</span>
                    <span>All Tenants</span>
                </a>
                <a href="/admin/reports.html" class="admin-nav-item">
                    <span class="icon">üìà</span>
                    <span>Reports</span>
                </a>
                <a href="/admin/pending-approvals.html" class="admin-nav-item">
                    <span class="icon">‚ö†Ô∏è</span>
                    <span>Pending Approvals</span>
                    <span class="badge" id="approvalsBadge" style="background:#f39c12;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:auto;display:none;">0</span>
                </a>
                <a href="/admin/pending-registrations.html" class="admin-nav-item">
                    <span class="icon">‚è≥</span>
                    <span>Pending Registrations</span>
                    <span class="badge" id="pendingBadge" style="background:#e74c3c;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:auto;display:none;">0</span>
                </a>
                <a href="/admin/logs.html" class="admin-nav-item active">
                    <span class="icon">üìù</span>
                    <span>Activity Logs</span>
                </a>
                <a href="/admin/settings.html" class="admin-nav-item">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </nav>

        <div class="admin-user">
            <div class="admin-user-info">
                <strong id="adminName">Loading...</strong>
                <small id="adminEmail">admin@system.local</small>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-content">
        <header class="content-header">
            <div>
                <h2 class="page-title">Activity Logs</h2>
                <p class="page-subtitle">System-wide activity monitoring and audit trail</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="refreshLogs()">Refresh</button>
                <button class="btn btn-secondary" onclick="exportLogs()">Export CSV</button>
            </div>
        </header>

        <!-- Filter Section -->
        <div class="filters-section">
            <div class="filter-group">
                <label>Activity Type:</label>
                <select id="filterType" onchange="filterLogs()">
                    <option value="">All Activities</option>
                    <option value="login">Login</option>
                    <option value="logout">Logout</option>
                    <option value="transaction">Transaction</option>
                    <option value="void">Void Transaction</option>
                    <option value="user">User Management</option>
                    <option value="company">Company Management</option>
                </select>
            </div>

            <div class="filter-group">
                <label>User Role:</label>
                <select id="filterRole" onchange="filterLogs()">
                    <option value="">All Users</option>
                    <option value="admin">Admin</option>
                    <option value="tenant">Tenant</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Date From:</label>
                <input type="date" id="filterDateFrom" onchange="filterLogs()">
            </div>

            <div class="filter-group">
                <label>Date To:</label>
                <input type="date" id="filterDateTo" onchange="filterLogs()">
            </div>

            <div class="filter-group">
                <label>Company:</label>
                <select id="filterCompany" onchange="filterLogs()">
                    <option value="">All Companies</option>
                </select>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Today's Activity</div>
                <div class="stat-value" id="todayActivity">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Users</div>
                <div class="stat-value" id="activeUsers">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Transactions Today</div>
                <div class="stat-value" id="transactionsToday">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Voided Today</div>
                <div class="stat-value" id="voidedToday">0</div>
            </div>
        </div>

        <!-- Activity Logs Table -->
        <div class="data-table-container">
            <table class="data-table" style="table-layout: fixed; width: 100%;">
                <thead>
                <tr>
                    <th style="width: 150px;">Timestamp</th>
                    <th style="width: 130px;">User</th>
                    <th style="width: 70px;">Role</th>
                    <th style="width: 130px;">Company</th>
                    <th style="width: 110px;">Activity</th>
                    <th style="width: 300px;">Details</th>
                    <th style="width: 110px;">IP Address</th>
                </tr>
                </thead>
                <tbody id="logsTableBody">
                <tr>
                    <td colspan="7" class="loading-cell">
                        <div class="loading-spinner"></div>
                        Loading activity logs...
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination">
            <button class="btn btn-secondary" onclick="previousPage()" id="prevBtn">Previous</button>
            <span class="pagination-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
            <button class="btn btn-secondary" onclick="nextPage()" id="nextBtn">Next</button>
        </div>
    </main>
</div>

<script>
    console.log('[ADMIN LOGS] Starting...');

    let allLogs = [];
    let filteredLogs = [];
    let currentPage = 1;
    const logsPerPage = 5;

    // Check authentication
    fetch('/php/api/auth/session.php', {
        credentials: 'include',
        headers: {
            'Accept': 'application/json'
        }
    })
        .then(response => {
            console.log('[LOGS] Session check response:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('[LOGS] Session data:', data);
            if (!data.success || data.data.user.role !== 'admin') {
                console.log('[LOGS] Invalid session or not admin');
                window.location.replace('/admin/login.html');
                return;
            }

            document.getElementById('adminName').textContent = data.data.user.full_name;
            document.getElementById('adminEmail').textContent = data.data.user.email;

            loadLogs();
            loadCompanies();
        })
        .catch(error => {
            console.error('[LOGS] Session error:', error);
            window.location.replace('/admin/login.html');
        });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
        fetch('/php/api/auth/logout.php', { method: 'POST' })
            .then(() => {
                // Clear history and redirect
                window.location.replace('/admin/login.html');
            });
    });

    // Load activity logs
    function loadLogs() {
        console.log('[ADMIN LOGS] Loading logs...');

        // Show loading state
        const tbody = document.getElementById('logsTableBody');
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px; color: #3498db;"><div class="loading-spinner"></div> Loading activity logs...</td></tr>';

        fetch('/php/api/admin/activity-logs.php?limit=500')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allLogs = data.data.logs || [];
                    updateStatistics(data.data.stats || {});
                    filterLogs();
                    console.log('[ADMIN LOGS] ‚úÖ Logs loaded successfully');
                } else {
                    throw new Error(data.message || 'Failed to load logs');
                }
            })
            .catch(error => {
                console.error('[ADMIN LOGS] Error:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px; color: #e74c3c;">
                            <strong>Error loading logs:</strong><br>
                            ${error.message}<br>
                            <button onclick="loadLogs()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Try Again
                            </button>
                        </td>
                    </tr>
                `;
            });
    }

    // Load companies for filter
    function loadCompanies() {
        fetch('/php/api/companies/list.php?limit=100')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const select = document.getElementById('filterCompany');
                    data.data.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.id;
                        option.textContent = company.company_name;
                        select.appendChild(option);
                    });
                }
            });
    }

    // Update statistics
    function updateStatistics(stats) {
        document.getElementById('todayActivity').textContent = stats.today_activity || 0;
        document.getElementById('activeUsers').textContent = stats.active_users || 0;
        document.getElementById('transactionsToday').textContent = stats.transactions_today || 0;
        document.getElementById('voidedToday').textContent = stats.voided_today || 0;
    }

    // Filter logs
    function filterLogs() {
        const typeFilter = document.getElementById('filterType').value;
        const roleFilter = document.getElementById('filterRole').value;
        const companyFilter = document.getElementById('filterCompany').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;

        filteredLogs = allLogs.filter(log => {
            if (typeFilter && log.activity_type !== typeFilter) return false;
            if (roleFilter && log.user_role !== roleFilter) return false;
            if (companyFilter && log.company_id != companyFilter) return false;
            if (dateFrom && log.created_at < dateFrom) return false;
            if (dateTo && log.created_at > dateTo + ' 23:59:59') return false;
            return true;
        });

        currentPage = 1;
        renderLogs();
    }

    // Render logs table
    function renderLogs() {
        const tbody = document.getElementById('logsTableBody');
        const start = (currentPage - 1) * logsPerPage;
        const end = start + logsPerPage;
        const pageData = filteredLogs.slice(start, end);

        if (pageData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #666;">No activity logs found</td></tr>';
            return;
        }

        tbody.innerHTML = pageData.map(log => `
                <tr>
                    <td>${formatDateTime(log.created_at)}</td>
                    <td>
                        <strong>${log.user_name || 'Unknown'}</strong>
                        <br><small>${log.username || 'N/A'}</small>
                    </td>
                    <td><span class="badge badge-${log.user_role === 'admin' ? 'admin' : 'tenant'}">${log.user_role}</span></td>
                    <td>${log.company_name || '<em>N/A</em>'}</td>
                    <td><span class="activity-type activity-${log.activity_type}">${formatActivityType(log.activity_type)}</span></td>
                    <td>${log.details || ''}</td>
                    <td><code>${log.ip_address || 'N/A'}</code></td>
                </tr>
            `).join('');

        updatePagination();
    }

    // Format activity type
    function formatActivityType(type) {
        const types = {
            'login': 'Login',
            'logout': 'Logout',
            'transaction': 'Transaction Created',
            'void': 'Transaction Voided',
            'user': 'User Management',
            'company': 'Company Management'
        };
        return types[type] || type;
    }

    // Format date/time
    function formatDateTime(datetime) {
        const date = new Date(datetime);
        return date.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Update pagination
    function updatePagination() {
        const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
        document.getElementById('currentPage').textContent = currentPage;
        document.getElementById('totalPages').textContent = totalPages || 1;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    // Pagination functions
    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            renderLogs();
        }
    }

    function nextPage() {
        const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderLogs();
        }
    }

    // Refresh logs
    function refreshLogs() {
        loadLogs();
    }

    // Export logs to CSV
    function exportLogs() {
        let csv = 'Timestamp,User,Role,Company,Activity,Details,IP Address\n';

        filteredLogs.forEach(log => {
            csv += `"${log.created_at}","${log.user_name}","${log.user_role}","${log.company_name || ''}","${formatActivityType(log.activity_type)}","${log.details || ''}","${log.ip_address || ''}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `activity-logs-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    }

    // Show error message
    function showError(message) {
        const tbody = document.getElementById('logsTableBody');
        tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 40px; color: #c00;">${message}</td></tr>`;
    }
</script>
</body>
</html>

