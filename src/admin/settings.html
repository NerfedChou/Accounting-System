<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Settings - Accounting System</title>

    <!-- Prevent page caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Immediate session check -->
    <script>
        document.documentElement.style.visibility = 'hidden';
        (function() {
            fetch('/php/api/auth/session.php')
                .then(res => res.json())
                .then(data => {
                    if (!data.success || data.data.user.role !== 'admin') {
                        window.location.replace('/admin/login.html');
                        return;
                    }
                    document.documentElement.style.visibility = 'visible';
                })
                .catch(() => window.location.replace('/admin/login.html'));
        })();
    </script>

    <link rel="stylesheet" href="/admin/assets/css/admin-professional.css">
    <script src="/admin/assets/js/badge-loader.js" defer></script>
    <script src="/admin/assets/js/notifications.js" defer></script>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar Navigation -->
        <aside class="admin-sidebar">
            <div class="admin-brand">
                <h1>Accounting System</h1>
                <p class="admin-role">Administrator</p>
            </div>

            <!-- Logout Button - Easy Access -->
            <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <button class="btn-logout" id="logoutBtn" style="width: 100%; padding: 1rem;">
                    Logout
                </button>
            </div>

            <nav class="admin-nav">
                <a href="/admin/dashboard.html" class="admin-nav-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/companies.html" class="admin-nav-item">
                    <span class="icon">üè¢</span>
                    <span>Companies</span>
                </a>
                <a href="/admin/accounts.html" class="admin-nav-item">
                    <span class="icon">üí∞</span>
                    <span>Account Management</span>
                </a>
                <a href="/admin/transactions.html" class="admin-nav-item">
                    <span class="icon">üí∏</span>
                    <span>All Transactions</span>
                </a>
                <a href="/admin/tenants.html" class="admin-nav-item">
                    <span class="icon">üë•</span>
                    <span>All Tenants</span>
                </a>
                <a href="/admin/reports.html" class="admin-nav-item">
                    <span class="icon">üìà</span>
                    <span>Reports</span>
                </a>
                <a href="/admin/pending-approvals.html" class="admin-nav-item">
                    <span class="icon">‚ö†Ô∏è</span>
                    <span>Pending Approvals</span>
                    <span class="badge" id="approvalsBadge" style="background:#f39c12;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:auto;display:none;">0</span>
                </a>
                <a href="/admin/pending-registrations.html" class="admin-nav-item">
                    <span class="icon">‚è≥</span>
                    <span>Pending Registrations</span>
                    <span class="badge" id="pendingBadge" style="background:#e74c3c;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:auto;display:none;">0</span>
                </a>
                <a href="/admin/logs.html" class="admin-nav-item">
                    <span class="icon">üìù</span>
                    <span>Activity Logs</span>
                </a>
                <a href="/admin/settings.html" class="admin-nav-item active">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </nav>

            <div class="admin-user">
                <div class="admin-user-info">
                    <strong id="username">Loading...</strong>
                    <small id="userEmail">admin@system.local</small>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <header class="content-header">
                <div>
                    <h2 class="page-title">Settings</h2>
                    <p class="page-subtitle">Manage your account and preferences</p>
                </div>
            </header>

            <div style="padding: 30px;">
                <!-- Settings Tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid #e9ecef;">
                    <button class="settings-tab active" onclick="showTab('profile')">
                        <span style="font-size: 18px;">üë§</span> Profile
                    </button>
                    <button class="settings-tab" onclick="showTab('security')">
                        <span style="font-size: 18px;">üîí</span> Security
                    </button>
                    <button class="settings-tab" onclick="showTab('preferences')">
                        <span style="font-size: 18px;">üé®</span> Preferences
                    </button>
                </div>

                <!-- Profile Tab -->
                <div id="profileTab" class="settings-content">
                    <div class="settings-card">
                        <h3 style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 20px;">
                            Personal Information
                        </h3>

                        <form id="profileForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Full Name <span style="color: red;">*</span></label>
                                    <input type="text" id="fullName" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label>Username <span style="color: red;">*</span></label>
                                    <input type="text" id="usernameField" class="form-input" required readonly>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Email <span style="color: red;">*</span></label>
                                    <input type="email" id="email" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label>Role</label>
                                    <input type="text" class="form-input" value="Administrator" readonly>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn-primary">
                                    üíæ Save Changes
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Account Stats -->
                    <div class="settings-card" style="margin-top: 30px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 20px;">
                            Account Statistics
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div class="stat-item">
                                <div class="stat-icon">üìÖ</div>
                                <div>
                                    <div class="stat-label">Member Since</div>
                                    <div class="stat-value" id="memberSince">-</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon">üïí</div>
                                <div>
                                    <div class="stat-label">Last Login</div>
                                    <div class="stat-value" id="lastLogin">-</div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-icon">üéØ</div>
                                <div>
                                    <div class="stat-label">Account Status</div>
                                    <div class="stat-value" style="color: #27ae60;">Active</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Tab -->
                <div id="securityTab" class="settings-content" style="display: none;">
                    <div class="settings-card">
                        <h3 style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 20px;">
                            Change Password
                        </h3>

                        <form id="passwordForm">
                            <div class="form-group">
                                <label>Current Password <span style="color: red;">*</span></label>
                                <input type="password" id="currentPassword" class="form-input" required>
                            </div>

                            <div class="form-group">
                                <label>New Password <span style="color: red;">*</span></label>
                                <input type="password" id="newPassword" class="form-input" required>
                                <small style="color: #666; font-size: 12px;">At least 6 characters</small>
                            </div>

                            <div class="form-group">
                                <label>Confirm New Password <span style="color: red;">*</span></label>
                                <input type="password" id="confirmPassword" class="form-input" required>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn-primary">
                                    üîí Update Password
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Security Features (Future Enhancement) -->
                    <div class="settings-card" style="margin-top: 30px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 20px;">
                            Two-Factor Authentication
                        </h3>
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-size: 32px;">üîê</span>
                                <div>
                                    <strong style="color: #2c3e50; display: block; margin-bottom: 5px;">Coming Soon</strong>
                                    <p style="color: #666; margin: 0; font-size: 14px;">
                                        Two-factor authentication will be available in a future update to enhance your account security.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preferences Tab -->
                <div id="preferencesTab" class="settings-content" style="display: none;">
                    <div class="settings-card">
                        <h3 style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 20px;">
                            Display Preferences
                        </h3>

                        <form id="preferencesForm">
                            <div class="form-group">
                                <label>Items Per Page</label>
                                <select id="itemsPerPage" class="form-input">
                                    <option value="5">5 items</option>
                                    <option value="10" selected>10 items</option>
                                    <option value="25">25 items</option>
                                    <option value="50">50 items</option>
                                </select>
                                <small style="color: #666; font-size: 12px;">Number of items to display in tables</small>
                            </div>

                            <div class="form-group">
                                <label>Date Format</label>
                                <select id="dateFormat" class="form-input">
                                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                    <option value="YYYY-MM-DD" selected>YYYY-MM-DD</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="showNotifications" checked style="margin-right: 8px;">
                                    Show desktop notifications
                                </label>
                            </div>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="autoRefresh" style="margin-right: 8px;">
                                    Auto-refresh dashboard every 5 minutes
                                </label>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn-primary">
                                    üíæ Save Preferences
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- System Info -->
                    <div class="settings-card" style="margin-top: 30px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 20px;">
                            System Information
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div class="info-item">
                                <span class="info-label">Version:</span>
                                <span class="info-value">1.0.0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Environment:</span>
                                <span class="info-value">Development</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Database:</span>
                                <span class="info-value">MySQL 8.0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">PHP Version:</span>
                                <span class="info-value">8.2</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <style>
        .settings-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.2s;
        }

        .settings-tab:hover {
            color: #2c3e50;
            background: rgba(52, 152, 219, 0.05);
        }

        .settings-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .settings-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-input:readonly {
            background: #f8f9fa;
            cursor: not-allowed;
        }

        .form-actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f8f9fa;
        }

        .btn-primary {
            padding: 12px 30px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-icon {
            font-size: 32px;
        }

        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .info-label {
            font-weight: 600;
            color: #7f8c8d;
        }

        .info-value {
            color: #2c3e50;
        }
    </style>

    <script>
        console.log('[ADMIN SETTINGS] Starting...');

        let currentUser = null;

        // Check authentication
        fetch('/php/api/auth/session.php')
            .then(response => response.json())
            .then(data => {
                if (!data.success || data.data.user.role !== 'admin') {
                    window.location.replace('/admin/login.html');
                    return;
                }

                currentUser = data.data.user;
                document.getElementById('username').textContent = currentUser.full_name;
                document.getElementById('userEmail').textContent = currentUser.email;

                loadUserProfile();
            })
            .catch(error => {
                console.error('[ADMIN SETTINGS] Session error:', error);
                window.location.replace('/admin/login.html');
            });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            fetch('/php/api/auth/logout.php', { method: 'POST' })
                .then(() => window.location.replace('/admin/login.html'));
        });

        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.settings-content').forEach(tab => {
                tab.style.display = 'none';
            });

            // Remove active class from all buttons
            document.querySelectorAll('.settings-tab').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').style.display = 'block';

            // Add active class to clicked button
            event.target.closest('.settings-tab').classList.add('active');
        }

        // Load user profile
        function loadUserProfile() {
            document.getElementById('fullName').value = currentUser.full_name || '';
            document.getElementById('usernameField').value = currentUser.username || '';
            document.getElementById('email').value = currentUser.email || '';

            // Set account stats
            if (currentUser.created_at) {
                document.getElementById('memberSince').textContent = new Date(currentUser.created_at).toLocaleDateString();
            }
            if (currentUser.last_login) {
                document.getElementById('lastLogin').textContent = new Date(currentUser.last_login).toLocaleString();
            }
        }

        // Profile form submission
        document.getElementById('profileForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;

            fetch('/php/api/settings/update-profile.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    full_name: fullName,
                    email: email
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(
                        'Profile Updated',
                        'Your profile information has been updated successfully.',
                        () => {
                            // Update session display
                            document.getElementById('username').textContent = fullName;
                            document.getElementById('userEmail').textContent = email;
                        }
                    );
                } else {
                    showError('Update Failed', data.message || 'Unable to update profile');
                }
            })
            .catch(error => {
                showError('Update Failed', error.message);
            });
        });

        // Password form submission
        document.getElementById('passwordForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validation
            if (newPassword.length < 6) {
                showError('Invalid Password', 'New password must be at least 6 characters long.');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('Password Mismatch', 'New password and confirmation do not match.');
                return;
            }

            fetch('/php/api/settings/change-password.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(
                        'Password Updated',
                        'Your password has been changed successfully. Please use your new password on next login.',
                        () => {
                            // Clear form
                            document.getElementById('passwordForm').reset();
                        }
                    );
                } else {
                    showError('Update Failed', data.message || 'Unable to update password');
                }
            })
            .catch(error => {
                showError('Update Failed', error.message);
            });
        });

        // Preferences form submission
        document.getElementById('preferencesForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const preferences = {
                items_per_page: document.getElementById('itemsPerPage').value,
                date_format: document.getElementById('dateFormat').value,
                show_notifications: document.getElementById('showNotifications').checked,
                auto_refresh: document.getElementById('autoRefresh').checked
            };

            // For now, store in localStorage (can be enhanced to save to database)
            localStorage.setItem('adminPreferences', JSON.stringify(preferences));

            showSuccess(
                'Preferences Saved',
                'Your preferences have been saved successfully and will be applied immediately.'
            );
        });

        // Load preferences on page load
        const savedPreferences = localStorage.getItem('adminPreferences');
        if (savedPreferences) {
            const prefs = JSON.parse(savedPreferences);
            document.getElementById('itemsPerPage').value = prefs.items_per_page || '10';
            document.getElementById('dateFormat').value = prefs.date_format || 'YYYY-MM-DD';
            document.getElementById('showNotifications').checked = prefs.show_notifications !== false;
            document.getElementById('autoRefresh').checked = prefs.auto_refresh === true;
        }
    </script>
</body>
</html>

