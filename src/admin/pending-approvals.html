<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pending Approvals - Admin</title>

    <!-- Prevent page caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Immediate session check -->
    <script>
        document.documentElement.style.visibility = 'hidden';
        (function() {
            fetch('/php/api/auth/session.php')
                .then(res => res.json())
                .then(data => {
                    if (!data.success || data.data.user.role !== 'admin') {
                        window.location.replace('/admin/login.html');
                        return;
                    }
                    document.documentElement.style.visibility = 'visible';
                })
                .catch(() => window.location.replace('/admin/login.html'));
        })();
    </script>

    <link rel="stylesheet" href="/admin/assets/css/admin-professional.css">
    <script src="/admin/assets/js/badge-loader.js" defer></script>
    <script src="/shared/js/notifications.js" defer></script>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-brand">
                <h1>Accounting System</h1>
                <p class="admin-role">Administrator</p>
            </div>

            <!-- Logout Button - Easy Access -->
            <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <button class="btn-logout" id="logoutBtn" style="width: 100%; padding: 1rem">
                    Logout
                </button>
            </div>

            <nav class="admin-nav">
                <a href="/admin/dashboard.html" class="admin-nav-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/companies.html" class="admin-nav-item">
                    <span class="icon">üè¢</span>
                    <span>Companies</span>
                </a>
                <a href="/admin/accounts.html" class="admin-nav-item">
                    <span class="icon">üí∞</span>
                    <span>Account Management</span>
                </a>
                <a href="/admin/transactions.html" class="admin-nav-item">
                    <span class="icon">üí∏</span>
                    <span>All Transactions</span>
                </a>
                <a href="/admin/tenants.html" class="admin-nav-item">
                    <span class="icon">üë•</span>
                    <span>All Tenants</span>
                </a>
                <a href="/admin/reports.html" class="admin-nav-item">
                    <span class="icon">üìà</span>
                    <span>Reports</span>
                </a>
                <a href="/admin/pending-approvals.html" class="admin-nav-item active">
                    <span class="icon">‚ö†Ô∏è</span>
                    <span>Pending Approvals</span>
                    <span class="badge" id="approvalsBadge" style="background:#f39c12;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:auto;display:none;">0</span>
                </a>
                <a href="/admin/pending-registrations.html" class="admin-nav-item">
                    <span class="icon">‚è≥</span>
                    <span>Pending Registrations</span>
                    <span class="badge" id="pendingRegBadge" style="background:#e74c3c;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:auto;display:none;">0</span>
                </a>
                <a href="/admin/logs.html" class="admin-nav-item">
                    <span class="icon">üìù</span>
                    <span>Activity Logs</span>
                </a>
                <a href="/admin/settings.html" class="admin-nav-item">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </nav>

            <div class="admin-user">
                <div class="admin-user-info">
                    <strong id="username">Admin</strong>
                    <small id="userEmail">admin@system.com</small>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <header class="content-header">
                <div>
                    <h2 class="page-title">Pending Approvals</h2>
                    <p class="page-subtitle">Review and approve/decline transactions requiring authorization</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="loadApprovals()">
                        <span id="refreshIcon" style="display: inline-block;"></span> Refresh
                    </button>
                </div>
            </header>

            <div style="padding: 30px;">
                <!-- Info Alert -->
                <div id="infoAlert" style="display: none; padding: 15px; margin-bottom: 20px; border-radius: 8px; background: #fff3cd; border-left: 5px solid #f39c12;">
                    <strong style="color: #856404;">Critical Approval Required</strong>
                    <p style="margin: 5px 0 0 0; color: #856404; font-size: 14px;">
                        These transactions involve rare but valid accounting scenarios (e.g., positive equity).
                        They require your review before posting to maintain financial integrity.
                    </p>
                </div>

                <!-- Filter Tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">
                    <button class="tab-btn active" onclick="filterStatus('pending')">Pending</button>
                    <button class="tab-btn" onclick="filterStatus('approved')">Approved</button>
                    <button class="tab-btn" onclick="filterStatus('declined')">Declined</button>
                    <button class="tab-btn" onclick="filterStatus('all')">All History</button>
                </div>

                <!-- Approvals List -->
                <div id="approvalsList"></div>

                <!-- Pagination Controls -->
                <div id="paginationControls" style="display: none; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="color: #555; font-size: 14px;">
                        Showing <strong id="showingStart">0</strong> to <strong id="showingEnd">0</strong> of <strong id="showingTotal">0</strong> items
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button id="prevBtn" onclick="previousPage()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" disabled>
                            ‚Üê Previous
                        </button>
                        <span id="pageInfo" style="display: flex; align-items: center; padding: 0 15px; color: #555; font-weight: 600;"></span>
                        <button id="nextBtn" onclick="nextPage()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" disabled>
                            Next ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" style="text-align: center; padding: 60px 20px; color: #7f8c8d; display: none;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">No Items Found</h3>
                    <p id="emptyMessage">Loading...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Transaction Details Modal -->
    <div id="detailsModal" class="modal" onclick="if(event.target === this) closeDetailsModal()">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Transaction Details</h3>
                <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="detailsContent">
                <!-- Details loaded here -->
            </div>
            <div class="modal-footer" id="detailsFooter">
                <button class="btn btn-secondary" onclick="closeDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Decline Modal -->
    <div id="declineModal" class="modal" onclick="if(event.target === this) closeDeclineModal()">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border-radius: 12px 12px 0 0;">
                <h3 style="color: white; margin: 0;">üö´ Decline Transaction</h3>
                <button class="modal-close" onclick="closeDeclineModal()" style="color: white; opacity: 0.9;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 30px 20px;">
                <!-- Warning Banner -->
                <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(238, 90, 111, 0.3);">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 12px;">
                        <div style="font-size: 40px;">üö´</div>
                        <div>
                            <strong style="color: white; font-size: 18px; display: block;">Critical Action</strong>
                            <p style="color: rgba(255,255,255,0.95); margin: 5px 0 0 0; font-size: 14px; line-height: 1.5;">
                                This transaction will be permanently rejected and removed
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Transaction Details -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #e74c3c;">
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #7f8c8d; font-size: 12px; text-transform: uppercase; display: block; margin-bottom: 5px;">Transaction Number</strong>
                        <span id="declineTransactionNumber" style="font-family: monospace; font-size: 16px; color: #2c3e50; font-weight: 700;"></span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 12px; text-transform: uppercase; display: block; margin-bottom: 5px;">Company</strong>
                        <span id="declineCompany" style="font-size: 14px; color: #2c3e50; font-weight: 600;"></span>
                    </div>
                </div>

                <!-- Reason Input -->
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <strong style="color: #856404; display: block; margin-bottom: 12px; font-size: 14px;">üìù Decline Reason Required</strong>
                    <p style="color: #856404; font-size: 13px; margin-bottom: 12px; line-height: 1.6;">
                        Please provide a clear, professional reason for declining this transaction. The tenant will be notified of your decision.
                    </p>
                    <textarea
                        id="declineReason"
                        rows="4"
                        style="width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                        placeholder="Example: Transaction violates company financial policy regarding equity distributions. Please consult with accounting department before resubmitting."
                    ></textarea>
                    <small style="color: #856404; font-size: 12px; margin-top: 5px; display: block;">
                        <strong>Tip:</strong> Be specific and constructive to help the tenant understand and correct the issue.
                    </small>
                </div>

                <!-- Impact Notice -->
                <div style="background: #f8d7da; border-left: 4px solid #e74c3c; padding: 15px; border-radius: 8px;">
                    <strong style="color: #721c24; display: block; margin-bottom: 8px; font-size: 13px;">‚ö†Ô∏è What Happens After Declining:</strong>
                    <ul style="margin: 0; padding-left: 20px; color: #721c24; font-size: 13px; line-height: 1.8;">
                        <li>Transaction will be <strong>permanently deleted</strong></li>
                        <li>Tenant receives notification with your reason</li>
                        <li>Action is <strong>logged</strong> for audit trail</li>
                        <li>Decline history is recorded</li>
                        <li>Tenant can create a corrected transaction</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer" style="background: #f8f9fa; padding: 20px; border-radius: 0 0 12px 12px;">
                <button class="btn btn-secondary" onclick="closeDeclineModal()" style="padding: 12px 24px; font-weight: 600;">
                    Cancel
                </button>
                <button class="btn btn-decline" onclick="confirmDecline()" style="padding: 12px 32px; font-weight: 700; font-size: 15px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4); color: white;">
                    üö´ Decline & Remove Transaction
                </button>
            </div>
        </div>
    </div>

    <!-- Approve Confirmation Modal -->
    <div id="approveModal" class="modal" onclick="if(event.target === this) closeApproveModal()" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation();">
            <div class="modal-header" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; border-radius: 12px 12px 0 0;">
                <h3 style="color: white; margin: 0;">‚úì Approve Transaction</h3>
                <button class="modal-close" onclick="closeApproveModal()" style="color: white; opacity: 0.9;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 30px 20px;">
                <!-- Warning Banner -->
                <div style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 12px;">
                        <div style="font-size: 40px;">‚ö†Ô∏è</div>
                        <div>
                            <strong style="color: white; font-size: 18px; display: block;">Authorization Required</strong>
                            <p style="color: rgba(255,255,255,0.95); margin: 5px 0 0 0; font-size: 14px; line-height: 1.5;">
                                This action will permanently post the transaction to the general ledger
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Transaction Details -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #7f8c8d; font-size: 12px; text-transform: uppercase; display: block; margin-bottom: 5px;">Transaction Number</strong>
                        <span id="approveTransactionNumber" style="font-family: monospace; font-size: 16px; color: #2c3e50; font-weight: 700;"></span>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #7f8c8d; font-size: 12px; text-transform: uppercase; display: block; margin-bottom: 5px;">Company</strong>
                        <span id="approveCompany" style="font-size: 14px; color: #2c3e50; font-weight: 600;"></span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 12px; text-transform: uppercase; display: block; margin-bottom: 5px;">Amount</strong>
                        <span id="approveAmount" style="font-size: 20px; color: #3498db; font-weight: 700;"></span>
                    </div>
                </div>

                <!-- Warning Checklist -->
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <strong style="color: #856404; display: block; margin-bottom: 12px; font-size: 14px;">üìã Pre-Approval Verification</strong>
                    <ul style="margin: 0; padding-left: 20px; color: #856404; line-height: 2;">
                        <li><strong>Transaction details are accurate and complete</strong></li>
                        <li><strong>Accounting principles and rules are followed</strong></li>
                        <li><strong>Account balances will remain valid</strong></li>
                        <li><strong>Company authorization policies are satisfied</strong></li>
                    </ul>
                </div>

                <!-- Impact Notice -->
                <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; border-radius: 8px;">
                    <strong style="color: #1565c0; display: block; margin-bottom: 8px; font-size: 13px;">‚ÑπÔ∏è Post-Approval Actions:</strong>
                    <ul style="margin: 0; padding-left: 20px; color: #1976d2; font-size: 13px; line-height: 1.8;">
                        <li>Transaction status changes to <strong>Posted</strong></li>
                        <li>Account balances update <strong>immediately</strong></li>
                        <li>Appears in financial reports and statements</li>
                        <li>Action is <strong>logged</strong> for audit trail</li>
                        <li>Transaction becomes <strong>immutable</strong> (cannot be edited)</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer" style="background: #f8f9fa; padding: 20px; border-radius: 0 0 12px 12px;">
                <button class="btn btn-secondary" onclick="closeApproveModal()" style="padding: 12px 24px; font-weight: 600;">
                    Cancel
                </button>
                <button class="btn btn-approve" onclick="console.log('[MODAL BUTTON] Approve clicked'); console.log('[MODAL BUTTON] currentTransactionId:', currentTransactionId); confirmApprove();" style="padding: 12px 32px; font-weight: 700; font-size: 15px; background: linear-gradient(135deg, #27ae60 0%, #229954 100%); border: none; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4); color: white;">
                    ‚úì Approve & Post Transaction
                </button>
            </div>
        </div>
    </div>

    <style>
        .tab-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            color: #7f8c8d;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: #f8f9fa;
        }

        .tab-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .approval-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .approval-card.pending {
            border-left: 5px solid #f39c12;
            background: #fffef8;
        }

        .approval-card.approved {
            border-left: 5px solid #27ae60;
        }

        .approval-card.declined {
            border-left: 5px solid #e74c3c;
        }

        .approval-card:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.1);
            cursor: pointer;
        }

        .approval-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .approval-info h4 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .approval-info p {
            font-size: 13px;
            color: #7f8c8d;
            margin: 2px 0;
        }

        .approval-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-approved { background: #d4edda; color: #155724; }
        .badge-declined { background: #f8d7da; color: #721c24; }

        .approval-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .approval-detail-item strong {
            display: block;
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 3px;
            text-transform: uppercase;
        }

        .approval-detail-item span {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 600;
        }

        .approval-actions {
            display: flex;
            gap: 8px;
        }

        .approval-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-approve { background: #27ae60; color: white; }
        .btn-approve:hover { background: #229954; }

        .btn-decline { background: #e74c3c; color: white; }
        .btn-decline:hover { background: #c0392b; }

        .btn-view { background: #3498db; color: white; }
        .btn-view:hover { background: #2980b9; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #95a5a6;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 2px solid #ecf0f1;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(52, 152, 219, 0.2);
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>

    <script>
        console.log('[PENDING APPROVALS] Starting...');

        let currentFilter = 'pending';
        let allApprovals = [];
        let currentTransactionId = null;
        let currentPage = 1;
        const itemsPerPage = 2;

        // Check auth
        fetch('/php/api/auth/session.php')
            .then(res => res.json())
            .then(data => {
                if (!data.success || data.data.user.role !== 'admin') {
                    window.location.href = '/admin/login.html';
                    return;
                }
                document.getElementById('username').textContent = data.data.user.full_name;
                document.getElementById('userEmail').textContent = data.data.user.email;
                loadApprovals();
            })
            .catch(() => window.location.href = '/admin/login.html');

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            fetch('/php/api/auth/logout.php', { method: 'POST' })
                .then(() => window.location.href = '/admin/login.html');
        });

        // Load approvals
        function loadApprovals() {
            console.log('[PENDING APPROVALS] Loading approvals for filter:', currentFilter);

            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.classList.add('spinning');

            // Show loading state
            const list = document.getElementById('approvalsList');
            const empty = document.getElementById('emptyState');
            empty.style.display = 'none';
            list.innerHTML = '<div style="text-align: center; padding: 40px; color: #3498db;"><div class="loading-spinner"></div><p style="margin-top: 15px;">Loading approvals...</p></div>';

            fetch(`/php/api/admin/approval-history.php?filter=${currentFilter}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        allApprovals = data.data;
                        console.log('[PENDING APPROVALS] ‚úÖ Loaded approvals:', allApprovals.length);
                        updateBadge();
                        renderApprovals();
                    } else {
                        throw new Error(data.message || 'Failed to load approvals');
                    }
                })
                .catch(err => {
                    console.error('[PENDING APPROVALS] Load error:', err);
                    list.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e74c3c;">
                            <strong>Error loading approvals:</strong><br>
                            ${err.message}<br>
                            <button onclick="loadApprovals()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Try Again
                            </button>
                        </div>
                    `;
                })
                .finally(() => {
                    refreshIcon.classList.remove('spinning');
                });
        }

        // Update badge
        function updateBadge() {
            // Get pending count separately
            fetch('/php/api/admin/approval-history.php?filter=pending')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const pending = data.data.length;
                        const badge = document.getElementById('approvalsBadge');
                        if (pending > 0) {
                            badge.textContent = pending;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                });
        }

        // Filter status
        function filterStatus(status) {
            currentFilter = status;
            currentPage = 1;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadApprovals();
        }

        // Render approvals
        function renderApprovals() {
            const list = document.getElementById('approvalsList');
            const empty = document.getElementById('emptyState');
            const infoAlert = document.getElementById('infoAlert');

            // Show info alert only for pending
            infoAlert.style.display = currentFilter === 'pending' && allApprovals.length > 0 ? 'block' : 'none';

            if (allApprovals.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                document.getElementById('paginationControls').style.display = 'none';

                if (currentFilter === 'pending') {
                    document.getElementById('emptyMessage').textContent = 'No pending approvals. All caught up!';
                } else if (currentFilter === 'approved') {
                    document.getElementById('emptyMessage').textContent = 'No approved transactions yet.';
                } else if (currentFilter === 'declined') {
                    document.getElementById('emptyMessage').textContent = 'No declined transactions yet.';
                } else {
                    document.getElementById('emptyMessage').textContent = 'No approval history found.';
                }
                return;
            }

            // Pagination logic
            const totalPages = Math.ceil(allApprovals.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, allApprovals.length);
            const pageItems = allApprovals.slice(startIndex, endIndex);

            empty.style.display = 'none';
            list.innerHTML = pageItems.map(item => {
                const isPending = item.action === 'pending' || !item.action;
                const actionBadge = isPending ? 'pending' : item.action;
                const actionLabel = isPending ? 'PENDING APPROVAL' : item.action.toUpperCase();

                return `
                <div class="approval-card ${actionBadge}" onclick="viewTransactionDetails(${item.transaction_id || item.id})">
                    <div class="approval-header">
                        <div class="approval-info">
                            <h4>
                                ${item.transaction_number}
                                <span class="approval-badge badge-${actionBadge}">${actionLabel}</span>
                            </h4>
                            <p><strong>Company:</strong> ${item.company_name} | <strong>Created By:</strong> ${item.created_by_name}</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 22px; font-weight: 700; color: ${isPending ? '#f39c12' : actionBadge === 'approved' ? '#27ae60' : '#e74c3c'};">
                                $${parseFloat(item.total_amount).toFixed(2)}
                            </div>
                        </div>
                    </div>

                    <div class="approval-details">
                        ${isPending ? `
                            <div class="approval-detail-item">
                                <strong>Status</strong>
                                <span style="color: #f39c12;">Awaiting Review</span>
                            </div>
                            <div class="approval-detail-item">
                                <strong>Created</strong>
                                <span>${formatDate(item.created_at)}</span>
                            </div>
                        ` : `
                            <div class="approval-detail-item">
                                <strong>Reviewed By</strong>
                                <span>${item.reviewed_by_name || 'N/A'}</span>
                            </div>
                            <div class="approval-detail-item">
                                <strong>Reviewed At</strong>
                                <span>${formatDate(item.reviewed_at)}</span>
                            </div>
                        `}
                    </div>

                    ${item.reason && !isPending ? `
                        <div style="padding: 12px; background: ${actionBadge === 'approved' ? '#d4edda' : '#f8d7da'}; border-radius: 8px; margin-bottom: 15px; font-size: 13px;">
                            <strong style="display: block; margin-bottom: 5px; color: ${actionBadge === 'approved' ? '#155724' : '#721c24'};">
                                ${actionBadge === 'approved' ? 'Approval Notes:' : 'Decline Reason:'}
                            </strong>
                            <span style="color: ${actionBadge === 'approved' ? '#155724' : '#721c24'};">${item.reason}</span>
                        </div>
                    ` : ''}

                    ${isPending ? `
                        <div class="approval-actions" onclick="event.stopPropagation()">
                            <button class="btn-approve" onclick="quickApprove(${item.id})">Approve</button>
                            <button class="btn-decline" onclick="quickDecline(${item.id}, '${item.transaction_number}', '${item.company_name}')">Decline</button>
                        </div>
                    ` : ''}
                </div>
            `}).join('');

            // Update pagination controls
            document.getElementById('paginationControls').style.display = 'flex';
            document.getElementById('showingStart').textContent = startIndex + 1;
            document.getElementById('showingEnd').textContent = endIndex;
            document.getElementById('showingTotal').textContent = allApprovals.length;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

            // Enable/disable buttons
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderApprovals();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(allApprovals.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderApprovals();
            }
        }

        // View transaction details
        async function viewTransactionDetails(id) {
            currentTransactionId = id;
            const modal = document.getElementById('detailsModal');
            const modalBody = document.getElementById('detailsContent');

            // Show modal with loading state
            modal.classList.add('show');
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 15px; color: #3498db;">Loading transaction details...</p>
                </div>
            `;

            try {
                const response = await fetch(`/php/api/admin/transaction-details.php?id=${id}`);
                const result = await response.json();

                if (result.success) {
                    showDetailsModal(result.data);
                } else {
                    modalBody.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e74c3c;">
                            <strong>Error loading transaction details:</strong><br>
                            ${result.message}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('[PENDING APPROVALS] Details error:', error);
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e74c3c;">
                        <strong>Error:</strong><br>
                        ${error.message}
                    </div>
                `;
            }
        }

        // Show details modal with data
        function showDetailsModal(transaction) {
            const modalBody = document.getElementById('detailsContent');
            const modalFooter = document.getElementById('detailsFooter');

            const isPending = transaction.status_id == 4 || transaction.requires_approval == 1;

            modalBody.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <strong style="color: #7f8c8d; font-size: 12px;">Transaction Number:</strong><br>
                        <span style="font-family: monospace; color: #2c3e50;">${transaction.transaction_number}</span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 12px;">Company:</strong><br>
                        <span style="color: #2c3e50;">${transaction.company_name}</span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 12px;">Date:</strong><br>
                        <span style="color: #2c3e50;">${transaction.transaction_date}</span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 12px;">Total Amount:</strong><br>
                        <span style="color: #3498db; font-size: 18px; font-weight: 700;">$${parseFloat(transaction.total_amount).toFixed(2)}</span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 12px;">Created By:</strong><br>
                        <span style="color: #2c3e50;">${transaction.created_by_name}</span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 12px;">Created At:</strong><br>
                        <span style="color: #2c3e50;">${formatDate(transaction.created_at)}</span>
                    </div>
                    <div>
                        <strong style="color: #7f8c8d; font-size: 12px;">Status:</strong><br>
                        <span style="background: ${isPending ? '#f39c12' : transaction.status_id == 2 ? '#27ae60' : '#e74c3c'}; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                            ${isPending ? 'PENDING APPROVAL' : transaction.status_name || 'Unknown'}
                        </span>
                    </div>
                    ${transaction.posted_at ? `
                        <div>
                            <strong style="color: #7f8c8d; font-size: 12px;">Posted At:</strong><br>
                            <span style="color: #2c3e50;">${formatDate(transaction.posted_at)}</span>
                        </div>
                    ` : ''}
                </div>

                ${isPending ? `
                    <div style="background: #fff3cd; border-left: 5px solid #f39c12; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
                        <strong style="color: #856404; font-size: 14px;">‚ö†Ô∏è Why This Needs Approval:</strong>
                        <p style="margin: 8px 0 0 0; color: #856404; font-size: 13px; line-height: 1.5;">
                            This transaction creates a rare but valid scenario in accounting (e.g., positive equity where owner owes money back to company).
                            It requires admin oversight to maintain financial integrity.
                        </p>
                    </div>
                ` : ''}

                <div style="margin-bottom: 20px;">
                    <strong style="color: #2c3e50; font-size: 14px;">Description:</strong><br>
                    <p style="margin: 8px 0 0 0; color: #555; line-height: 1.5;">${transaction.description || '<em>No description provided</em>'}</p>
                </div>

                <div>
                    <strong style="color: #2c3e50; font-size: 14px; display: block; margin-bottom: 10px;">Transaction Lines:</strong>
                    <div style="border: 2px solid #e9ecef; border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #e9ecef;">Account</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #e9ecef;">Type</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #e9ecef;">Debit</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #e9ecef;">Credit</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${transaction.lines.map((line, index) => `
                                    <tr style="${index < transaction.lines.length - 1 ? 'border-bottom: 1px solid #e9ecef;' : ''}">
                                        <td style="padding: 12px;">
                                            <div style="font-weight: 600; color: #2c3e50;">${line.account_name}</div>
                                            <div style="font-size: 12px; color: #7f8c8d; font-family: monospace;">${line.account_code}</div>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            <span style="text-transform: uppercase; font-weight: 600; color: ${line.line_type === 'debit' ? '#27ae60' : '#e74c3c'}; font-size: 11px; background: ${line.line_type === 'debit' ? '#d4edda' : '#f8d7da'}; padding: 4px 8px; border-radius: 4px;">
                                                ${line.line_type}
                                            </span>
                                        </td>
                                        <td style="padding: 12px; text-align: right; color: #27ae60; font-weight: 700; font-size: 15px;">
                                            ${line.line_type === 'debit' ? '$' + parseFloat(line.amount).toFixed(2) : '-'}
                                        </td>
                                        <td style="padding: 12px; text-align: right; color: #e74c3c; font-weight: 700; font-size: 15px;">
                                            ${line.line_type === 'credit' ? '$' + parseFloat(line.amount).toFixed(2) : '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr style="background: #f8f9fa; border-top: 2px solid #e9ecef;">
                                    <td colspan="2" style="padding: 12px; text-align: right; font-weight: 700; color: #2c3e50;">TOTAL:</td>
                                    <td style="padding: 12px; text-align: right; color: #27ae60; font-weight: 700; font-size: 15px;">
                                        $${transaction.lines.filter(l => l.line_type === 'debit').reduce((sum, l) => sum + parseFloat(l.amount), 0).toFixed(2)}
                                    </td>
                                    <td style="padding: 12px; text-align: right; color: #e74c3c; font-weight: 700; font-size: 15px;">
                                        $${transaction.lines.filter(l => l.line_type === 'credit').reduce((sum, l) => sum + parseFloat(l.amount), 0).toFixed(2)}
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;

            // Update footer based on status
            if (isPending) {
                modalFooter.innerHTML = `
                    <button class="btn btn-secondary" onclick="closeDetailsModal()">Close</button>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-decline" onclick="closeDetailsModal(); quickDecline(${transaction.id}, '${transaction.transaction_number}', '${transaction.company_name}');">
                            Decline
                        </button>
                        <button class="btn btn-approve" onclick="closeDetailsModal(); quickApprove(${transaction.id});">
                            Approve & Post
                        </button>
                    </div>
                `;
            } else {
                modalFooter.innerHTML = `
                    <button class="btn btn-secondary" onclick="closeDetailsModal()">Close</button>
                `;
            }
        }

        // Close details modal
        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('show');
            currentTransactionId = null;
        }

        // Quick approve - show custom modal
        function quickApprove(id) {
            currentTransactionId = id;

            // Find transaction data
            const transaction = allApprovals.find(t => t.id === id || t.transaction_id === id);

            if (transaction) {
                document.getElementById('approveTransactionNumber').textContent = transaction.transaction_number;
                document.getElementById('approveCompany').textContent = transaction.company_name;
                document.getElementById('approveAmount').textContent = '$' + parseFloat(transaction.total_amount).toFixed(2);
            }

            document.getElementById('approveModal').classList.add('show');
        }

        // Close approve modal
        function closeApproveModal() {
            document.getElementById('approveModal').classList.remove('show');
            currentTransactionId = null;
        }

        // Confirm approve from modal
        async function confirmApprove() {
            if (!currentTransactionId) return;

            const approveBtn = document.querySelector('#approveModal .btn-approve');
            const originalBtnText = approveBtn.innerHTML;
            approveBtn.disabled = true;
            approveBtn.innerHTML = '<div class="loading-spinner-small"></div> Processing...';

            try {
                // Call the actual approve function
                await approveTransaction();
            } finally {
                // Restore button state
                approveBtn.disabled = false;
                approveBtn.innerHTML = originalBtnText;
                // Close modal only after API call is complete
                closeApproveModal();
            }
        }

        // Approve transaction
        async function approveTransaction() {
            if (!currentTransactionId) return;

            try {
                console.log('[APPROVALS] Sending approval request for transaction:', currentTransactionId);

                const response = await fetch('/php/api/admin/approve-transaction.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: currentTransactionId })
                });

                console.log('[APPROVALS] Response status:', response.status);

                const result = await response.json();

                console.log('[APPROVALS] Response data:', result);

                if (result.success) {
                    console.log('[APPROVALS] ‚úÖ Approval successful');
                    Notify.success('Transaction Approved', 'Transaction has been approved and posted successfully!');
                    currentTransactionId = null;
                    loadApprovals();
                } else {
                    console.error('[APPROVALS] ‚ùå Approval failed:', result.message);
                    Notify.error('Approval Failed', result.message);
                }
            } catch (error) {
                console.error('[APPROVALS] Error:', error);
                Notify.error('Error', 'Failed to approve transaction: ' + error.message);
            }
        }

        // Quick decline
        function quickDecline(id, transactionNumber, companyName) {
            currentTransactionId = id;
            document.getElementById('declineTransactionNumber').textContent = transactionNumber;
            document.getElementById('declineCompany').textContent = companyName;
            document.getElementById('declineReason').value = '';
            document.getElementById('declineModal').classList.add('show');
        }

        // Close decline modal
        function closeDeclineModal() {
            document.getElementById('declineModal').classList.remove('show');
            currentTransactionId = null;
        }

        // Confirm decline
        async function confirmDecline() {
            const reason = document.getElementById('declineReason').value.trim();

            if (!reason) {
                Notify.error('Reason Required', 'Please provide a reason for declining this transaction.');
                return;
            }

            if (!currentTransactionId) return;

            try {
                const response = await fetch('/php/api/admin/decline-transaction.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: currentTransactionId,
                        reason: reason
                    })
                });

                const result = await response.json();

                if (result.success) {
                    Notify.success('Transaction Declined', 'Transaction has been declined successfully.');
                    closeDeclineModal();
                    closeDetailsModal();
                    loadApprovals();
                } else {
                    Notify.error('Decline Failed', result.message);
                }
            } catch (error) {
                console.error('[PENDING APPROVALS] Decline error:', error);
                Notify.error('Error', error.message);
            }
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Auto-refresh every 30 seconds
        setInterval(loadApprovals, 30000);
    </script>
</body>
</html>

