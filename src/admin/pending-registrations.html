<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pending Registrations - Admin</title>

    <!-- Prevent page caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Immediate session check -->
    <script>
        document.documentElement.style.visibility = 'hidden';
        (function() {
            fetch('/php/api/auth/session.php')
                .then(res => res.json())
                .then(data => {
                    if (!data.success || data.data.user.role !== 'admin') {
                        window.location.replace('/admin/login.html');
                        return;
                    }
                    document.documentElement.style.visibility = 'visible';
                })
                .catch(() => window.location.replace('/admin/login.html'));
        })();
    </script>

    <link rel="stylesheet" href="/admin/assets/css/admin-professional.css">
    <script src="/admin/assets/js/badge-loader.js" defer></script>
    <script src="/admin/assets/js/notifications.js" defer></script>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-brand">
                <h1>Accounting System</h1>
                <p class="admin-role">Administrator</p>
            </div>

            <!-- Logout Button - Easy Access -->
            <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <button class="btn-logout" id="logoutBtn" style="width: 100%; padding: 1rem">
                    Logout
                </button>
            </div>

            <nav class="admin-nav">
                <a href="/admin/dashboard.html" class="admin-nav-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/admin/companies.html" class="admin-nav-item">
                    <span class="icon">üè¢</span>
                    <span>Companies</span>
                </a>
                <a href="/admin/accounts.html" class="admin-nav-item">
                    <span class="icon">üí∞</span>
                    <span>Account Management</span>
                </a>
                <a href="/admin/transactions.html" class="admin-nav-item">
                    <span class="icon">üí∏</span>
                    <span>All Transactions</span>
                </a>
                <a href="/admin/tenants.html" class="admin-nav-item">
                    <span class="icon">üë•</span>
                    <span>All Tenants</span>
                </a>
                <a href="/admin/reports.html" class="admin-nav-item">
                    <span class="icon">üìà</span>
                    <span>Reports</span>
                </a>
                <a href="/admin/pending-approvals.html" class="admin-nav-item">
                    <span class="icon">‚ö†Ô∏è</span>
                    <span>Pending Approvals</span>
                    <span class="badge" id="approvalsBadge" style="background:#f39c12;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:auto;display:none;">0</span>
                </a>
                <a href="/admin/pending-registrations.html" class="admin-nav-item active">
                    <span class="icon">‚è≥</span>
                    <span>Pending Registrations</span>
                    <span class="badge" id="pendingBadge" style="background:#e74c3c;color:white;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:auto;display:none;">0</span>
                </a>
                <a href="/admin/logs.html" class="admin-nav-item">
                    <span class="icon">üìù</span>
                    <span>Activity Logs</span>
                </a>
                <a href="/admin/settings.html" class="admin-nav-item">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </nav>

            <div class="admin-user">
                <div class="admin-user-info">
                    <strong id="username">Admin</strong>
                    <small id="userEmail">admin@system.com</small>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-content">
            <header class="content-header">
                <div>
                    <h2 class="page-title">Pending Registrations</h2>
                    <p class="page-subtitle">Review and approve tenant registrations</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="loadRegistrations()">Refresh</button>
                </div>
            </header>

            <div style="padding: 30px;">
                <!-- Filter Tabs -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">
                    <button class="tab-btn active" onclick="filterStatus('all')">All</button>
                    <button class="tab-btn" onclick="filterStatus('pending')">Pending</button>
                    <button class="tab-btn" onclick="filterStatus('approved')">Approved</button>
                    <button class="tab-btn" onclick="filterStatus('declined')">Declined</button>
                </div>

                <!-- Registrations List -->
                <div id="registrationsList"></div>

                <!-- Pagination Controls -->
                <div id="paginationControls" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="color: #555; font-size: 14px;">
                        Showing <strong id="showingStart">0</strong> to <strong id="showingEnd">0</strong> of <strong id="showingTotal">0</strong> registrations
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button id="prevBtn" onclick="previousPage()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" disabled>
                            ‚Üê Previous
                        </button>
                        <span id="pageInfo" style="display: flex; align-items: center; padding: 0 15px; color: #555; font-weight: 600;"></span>
                        <button id="nextBtn" onclick="nextPage()" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" disabled>
                            Next ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="emptyState" style="text-align: center; padding: 60px 20px; color: #7f8c8d; display: none;">
                    <div style="font-size: 48px; margin-bottom: 20px;">üìã</div>
                    <h3 style="color: #2c3e50; margin-bottom: 10px;">No Pending Registrations</h3>
                    <p>All caught up! New registrations will appear here.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Approve Modal -->
    <div id="approveModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Approve Registration</h3>
                <button class="modal-close" onclick="closeApproveModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px;">Assign this tenant to a company:</p>

                <div style="margin-bottom: 20px;">
                    <strong id="approveUserName"></strong><br>
                    <small id="approveUserEmail" style="color: #7f8c8d;"></small>
                </div>

                <label style="display: block; font-weight: 600; margin-bottom: 8px;">Select Company <span style="color: red;">*</span></label>
                <select id="approveCompanyId" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                    <option value="">Loading companies...</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeApproveModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmApprove()" style="background: #27ae60;">Approve</button>
            </div>
        </div>
    </div>

    <!-- Decline Modal -->
    <div id="declineModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Decline Registration</h3>
                <button class="modal-close" onclick="closeDeclineModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px;">Provide a reason for declining:</p>

                <div style="margin-bottom: 20px;">
                    <strong id="declineUserName"></strong><br>
                    <small id="declineUserEmail" style="color: #7f8c8d;"></small>
                </div>

                <label style="display: block; font-weight: 600; margin-bottom: 8px;">Reason <span style="color: red;">*</span></label>
                <textarea id="declineReason" rows="4" style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;" placeholder="e.g., Incomplete information, duplicate account, etc."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeclineModal()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmDecline()" style="background: #e74c3c;">Decline</button>
            </div>
        </div>
    </div>

    <!-- View Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Registration Details</h3>
                <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="detailsContent">
                <!-- Details loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <style>
        .tab-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            color: #7f8c8d;
        }

        .tab-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .reg-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .reg-card:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.1);
        }

        .reg-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .reg-info h4 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .reg-info p {
            font-size: 13px;
            color: #7f8c8d;
            margin: 2px 0;
        }

        .reg-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-approved { background: #d4edda; color: #155724; }
        .badge-declined { background: #f8d7da; color: #721c24; }

        .reg-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .reg-detail-item {
            min-width: 0; /* Allow text truncation */
        }

        .reg-detail-item strong {
            display: block;
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 3px;
            text-transform: uppercase;
        }

        .reg-detail-item span {
            font-size: 14px;
            color: #2c3e50;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .reg-detail-item span:hover {
            white-space: normal;
            word-break: break-word;
        }

        .reg-actions {
            display: flex;
            gap: 8px;
        }

        .reg-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-approve { background: #27ae60; color: white; }
        .btn-approve:hover { background: #229954; }

        .btn-decline { background: #e74c3c; color: white; }
        .btn-decline:hover { background: #c0392b; }

        .btn-view { background: #95a5a6; color: white; }
        .btn-view:hover { background: #7f8c8d; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #95a5a6;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 2px solid #ecf0f1;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>

    <script>
        console.log('[PENDING REGISTRATIONS] Starting...');

        let currentFilter = 'all';
        let allRegistrations = [];
        let currentApproveUserId = null;
        let currentDeclineUserId = null;
        let currentPage = 1;
        const itemsPerPage = 2;

        // Check auth
        fetch('/php/api/auth/session.php')
            .then(res => res.json())
            .then(data => {
                if (!data.success || data.data.user.role !== 'admin') {
                    window.location.href = '/admin/login.html';
                    return;
                }
                document.getElementById('username').textContent = data.data.user.full_name;
                document.getElementById('userEmail').textContent = data.data.user.email;
                loadRegistrations();
                loadCompanies();
            })
            .catch(() => window.location.href = '/admin/login.html');

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            fetch('/php/api/auth/logout.php', { method: 'POST' })
                .then(() => window.location.href = '/admin/login.html');
        });

        // Load registrations
        function loadRegistrations() {
            console.log('[PENDING REGISTRATIONS] Loading registrations...');

            // Show loading state
            const list = document.getElementById('registrationsList');
            const empty = document.getElementById('emptyState');
            empty.style.display = 'none';
            list.innerHTML = '<div style="text-align: center; padding: 40px; color: #3498db;"><div class="loading-spinner"></div><p style="margin-top: 15px;">Loading registrations...</p></div>';

            fetch(`/php/api/admin/pending-registrations.php?status=${currentFilter}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        allRegistrations = data.data.registrations;
                        console.log('[PENDING REGISTRATIONS] ‚úÖ Loaded registrations:', allRegistrations.length);
                        updateBadge();
                        renderRegistrations();
                    } else {
                        throw new Error(data.message || 'Failed to load registrations');
                    }
                })
                .catch(err => {
                    console.error('[PENDING REGISTRATIONS] Load error:', err);
                    list.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e74c3c;">
                            <strong>Error loading registrations:</strong><br>
                            ${err.message}<br>
                            <button onclick="loadRegistrations()" style="margin-top: 10px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Try Again
                            </button>
                        </div>
                    `;
                });
        }

        // Update badge
        function updateBadge() {
            const pending = allRegistrations.filter(r => r.registration_status === 'pending').length;
            const badge = document.getElementById('pendingBadge');
            if (pending > 0) {
                badge.textContent = pending;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
            console.log('Pending count:', pending);
        }

        // Filter status
        function filterStatus(status) {
            currentFilter = status;
            currentPage = 1; // Reset to first page
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadRegistrations();
        }

        // Render registrations
        function renderRegistrations() {
            const list = document.getElementById('registrationsList');
            const empty = document.getElementById('emptyState');

            if (allRegistrations.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                document.getElementById('paginationControls').style.display = 'none';
                return;
            }

            // Pagination logic
            const totalPages = Math.ceil(allRegistrations.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, allRegistrations.length);
            const pageItems = allRegistrations.slice(startIndex, endIndex);

            empty.style.display = 'none';
            list.innerHTML = pageItems.map(reg => `
                <div class="reg-card">
                    <div class="reg-header">
                        <div class="reg-info">
                            <h4>${reg.full_name}</h4>
                            <p>@${reg.username} ‚Ä¢ ${reg.email}</p>
                        </div>
                        <span class="reg-badge badge-${reg.registration_status}">${reg.registration_status}</span>
                    </div>

                    <div class="reg-details">
                        <div class="reg-detail-item">
                            <strong>Company Requested</strong>
                            <span>${reg.company_name_requested || 'Not specified'}</span>
                        </div>
                        <div class="reg-detail-item">
                            <strong>Business Type</strong>
                            <span>${reg.business_type || 'Not specified'}</span>
                        </div>
                        <div class="reg-detail-item">
                            <strong>Registered</strong>
                            <span>${formatDate(reg.registration_date || reg.created_at)}</span>
                        </div>
                        <div class="reg-detail-item">
                            <strong>Waiting</strong>
                            <span>${reg.days_waiting || 0} days</span>
                        </div>
                    </div>

                    ${reg.registration_notes ? `
                        <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px; font-size: 13px;">
                            <strong style="display: block; margin-bottom: 5px;">Notes:</strong>
                            ${reg.registration_notes}
                        </div>
                    ` : ''}

                    <div class="reg-actions">
                        ${reg.registration_status === 'pending' ? `
                            <button class="btn-approve" onclick="openApproveModal(${reg.id}, '${reg.full_name}', '${reg.email}')">‚úì Approve</button>
                            <button class="btn-decline" onclick="openDeclineModal(${reg.id}, '${reg.full_name}', '${reg.email}')">‚úó Decline</button>
                        ` : ''}
                        <button class="btn-view" onclick="viewDetails(${reg.id})">üëÅ View Details</button>
                    </div>
                </div>
            `).join('');

            // Update pagination controls
            document.getElementById('paginationControls').style.display = 'flex';
            document.getElementById('showingStart').textContent = startIndex + 1;
            document.getElementById('showingEnd').textContent = endIndex;
            document.getElementById('showingTotal').textContent = allRegistrations.length;
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;

            // Enable/disable buttons
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        // Pagination functions
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderRegistrations();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(allRegistrations.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderRegistrations();
            }
        }

        // Load companies
        function loadCompanies() {
            fetch('/php/api/companies/list.php')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const select = document.getElementById('approveCompanyId');
                        select.innerHTML = '<option value="">Select a company</option>' +
                            data.data.map(c => `<option value="${c.id}">${c.company_name}</option>`).join('');
                    }
                })
                .catch(err => console.error('Load companies error:', err));
        }

        // Open approve modal
        function openApproveModal(userId, name, email) {
            currentApproveUserId = userId;
            document.getElementById('approveUserName').textContent = name;
            document.getElementById('approveUserEmail').textContent = email;
            document.getElementById('approveCompanyId').value = '';
            document.getElementById('approveModal').classList.add('show');
        }

        function closeApproveModal() {
            document.getElementById('approveModal').classList.remove('show');
            currentApproveUserId = null;
        }

        // Confirm approve
        function confirmApprove() {
            const companyId = document.getElementById('approveCompanyId').value;
            if (!companyId) {
                showError('Company Required', 'Please select a company to assign this tenant to.');
                return;
            }

            const userName = document.getElementById('approveUserName').textContent;

            fetch('/php/api/admin/approve-registration.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: currentApproveUserId, company_id: companyId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    closeApproveModal();
                    showSuccess(
                        'Registration Approved',
                        `<strong>${userName}</strong> has been approved and assigned to the selected company. They can now log in and access the system.`,
                        () => loadRegistrations()
                    );
                } else {
                    showError('Approval Failed', data.message || 'Unable to approve registration');
                }
            })
            .catch(err => {
                console.error('Approve error:', err);
                showError('Approval Failed', err.message);
            });
        }

        // Open decline modal
        function openDeclineModal(userId, name, email) {
            currentDeclineUserId = userId;
            document.getElementById('declineUserName').textContent = name;
            document.getElementById('declineUserEmail').textContent = email;
            document.getElementById('declineReason').value = '';
            document.getElementById('declineModal').classList.add('show');
        }

        function closeDeclineModal() {
            document.getElementById('declineModal').classList.remove('show');
            currentDeclineUserId = null;
        }

        // Confirm decline
        function confirmDecline() {
            const reason = document.getElementById('declineReason').value.trim();
            if (!reason) {
                showError('Reason Required', 'Please provide a reason for declining this registration.');
                return;
            }

            const userName = document.getElementById('declineUserName').textContent;

            fetch('/php/api/admin/decline-registration.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: currentDeclineUserId, reason: reason })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    closeDeclineModal();
                    showSuccess(
                        'Registration Declined',
                        `<strong>${userName}</strong>'s registration has been declined.<br><br>Reason provided: ${reason}`,
                        () => loadRegistrations()
                    );
                } else {
                    showError('Decline Failed', data.message || 'Unable to decline registration');
                }
            })
            .catch(err => {
                console.error('Decline error:', err);
                showError('Decline Failed', err.message);
            });
        }

        // View details
        function viewDetails(userId) {
            fetch(`/php/api/admin/registration-details.php?id=${userId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showDetailsModal(data.data);
                    }
                })
                .catch(err => console.error('Details error:', err));
        }

        function showDetailsModal(user) {
            const content = document.getElementById('detailsContent');
            content.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div><strong>Full Name:</strong> ${user.full_name}</div>
                    <div><strong>Username:</strong> ${user.username}</div>
                    <div><strong>Email:</strong> ${user.email}</div>
                    <div><strong>Company Requested:</strong> ${user.company_name_requested || 'Not specified'}</div>
                    <div><strong>Business Type:</strong> ${user.business_type || 'Not specified'}</div>
                    <div><strong>Registration Date:</strong> ${formatDate(user.registration_date || user.created_at)}</div>
                    <div><strong>Status:</strong> <span class="reg-badge badge-${user.registration_status}">${user.registration_status}</span></div>
                    ${user.registration_notes ? `<div><strong>Notes:</strong><br>${user.registration_notes}</div>` : ''}
                    ${user.approved_by_name ? `<div><strong>Reviewed By:</strong> ${user.approved_by_name}</div>` : ''}
                    ${user.approved_at ? `<div><strong>Reviewed At:</strong> ${formatDate(user.approved_at)}</div>` : ''}
                    ${user.declined_reason ? `<div><strong>Decline Reason:</strong><br>${user.declined_reason}</div>` : ''}
                    ${user.assigned_company_name ? `<div><strong>Assigned Company:</strong> ${user.assigned_company_name}</div>` : ''}
                </div>
            `;
            document.getElementById('detailsModal').classList.add('show');
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.remove('show');
        }

        // Format date
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
    </script>
</body>
</html>

